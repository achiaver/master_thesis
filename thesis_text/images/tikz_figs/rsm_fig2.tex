\begin{figure}[h!tbp]{\textwidth}
    \centering
    \caption{REPLICATED SOFTMAX MODEL}%
    \label{fig:rsm-network}%
    \begin{tikzpicture}[%
        visible/.style={draw, circle, thick, on grid, align=center, text width=1cm, inner sep=0pt},
    hidden/.style={draw, circle, thick, on grid, align=center, text width=1cm, inner sep=0pt, fill=gray}]

%        \draw[help lines] (-5,-7) grid (5,4);

% k = 1 and all D words
        \node [visible] (v31) {$v_{31}$};
        \node [visible, right=4cm of v31] (vD1) {$v_{D1}$};
        \node [visible, left=2cm of v31] (v21) {$v_{21}$};
        \node [visible, left=2cm of v21] (v11) {$v_{11}$};
        \node at ($(v31)!.5!(vD1)$) {$\dots$};

% k = 2 and all D words
        \node [visible, below=2cm of v31] (v32) {$v_{32}$};
        \node [visible, right=4cm of v32] (vD2) {$v_{D2}$};
        \node [visible, left=2cm of v32] (v22) {$v_{22}$};
        \node [visible, left=2cm of v22] (v12) {$v_{12}$};
        \node  at ($(v32)!.5!(vD2)$) {$\dots$};


% k = K and all D words
        \node [visible, below=4cm of v32] (v3K) {$v_{3K}$};
        \node [visible, right=4cm of v3K] (vDK) {$v_{DK}$};
        \node [visible, left=2cm of v3K] (v2K) {$v_{2K}$};
        \node [visible, left=2cm of v2K] (v1K) {$v_{1K}$};
        \node  at ($(v3K)!.5!(vDK)$) {$\dots$};

% k = . . . and all D words
        \path (v12) -- (v1K) node [midway, sloped] {$\dots$};
        \path (v22) -- (v2K) node [midway, sloped] {$\dots$};
        \path (v32) -- (v3K) node [midway, sloped] {$\dots$};
        \path (v32) -- (vDK) node [midway, sloped] {$\dots$};
        \path (vD2) -- (vDK) node [midway, sloped] {$\dots$};

        \node [hidden, above left=3cm and 1cm of v31] (h2) {$h_{2}$};
        \node [hidden, right=4cm of h2] (hF) {$h_{F}$};
        \node [hidden, left=2cm of h2] (h1) {$h_{1}$};
        \path (h2) -- (hF) node [midway, sloped] {$\dots$};

        \begin{scope}[on background layer]
            \node [draw, very thick, rounded corners=10pt, fit=(v11) (vD1) (v1K) (vDK)] (visible) {};
    
            \node [draw, very thick, rounded corners=10pt, fit=(h1) (hF), fill=lightgray] (hidden) {};
            
            \path [draw, very thick] (visible) -- (hidden) node [midway, right] {$\mathbf{W}$};
    
            \node (visiblelabel) [left=of visible] {$\mathbf{V}$};
            \node (hiddenlabel) [left=of hidden] {$\mathbf{h}$};
        \end{scope}

%        \foreach \x in {1,...,9}{%
%            \foreach \y in {1,...,5}{%
%                \draw[thick] (A\x) -- (B\y);
%            }
%        }
%        \foreach \x in {1,...,5}{%
%            \foreach \y in {1,...,5}{%
%                \draw[thick] (B\x) -- (C\y);
%            }
%        }
%        \draw (A5) -- node[right] {$\mathbf{W}$} (B3);
%        \draw (B3) -- node[right] {${\bf W}_2$} (C3);
    \end{tikzpicture}
    \legend{%
        Replicated Softmax model. 
        The top layer represents the hidden layer, denoted by vector $\mathbf{h} = (h_{1}, h_{2}, \dots, h_{F})$, of stochastic binary units. 
        The bottom layer, denoted by matrix $\mathbf{V}$, represents the visible layer with units $v_{ik}$, $i = 1,\dots,D$ and $k = 1,\dots,K$.
        Between visible and hidden units are the weights $w_{ijk}$, which is a symmetric connection, denoted by tensor $\mathbf{W}$.
    }%
    \source{Author}
\end{figure}




